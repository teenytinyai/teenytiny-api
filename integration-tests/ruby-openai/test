#!/bin/bash

set -e

# Change to the directory containing this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Use environment variables or defaults
export TEENYTINY_URL=${TEENYTINY_URL:-"http://localhost:8080"}
export TEENYTINY_API_KEY=${TEENYTINY_API_KEY:-"testkey"}

echo "Running Ruby OpenAI gem integration tests..."
echo "Target: $TEENYTINY_URL (${TEENYTINY_API_KEY:0:7}...)"
echo

# Install dependencies quietly
bundle install --quiet

# Run RSpec tests
bundle exec rspec --no-profile "$@"

# Fix the testsuite name in the generated XML  
sed -i '' 's/name="rspec"/name="ruby-openai"/g' ../reports/ruby-openai.xml 2>/dev/null || true